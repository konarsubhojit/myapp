name: Deploy to Azure Container Apps

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      backend_tag:
        description: 'Backend image tag to deploy'
        required: false
        default: 'latest'
        type: string
      frontend_tag:
        description: 'Frontend image tag to deploy'
        required: false
        default: 'latest'
        type: string

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}-backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}-frontend

permissions:
  contents: read
  packages: read

jobs:
  deploy-backend:
    name: Deploy Backend to Azure Container Apps
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ vars.AZURE_RESOURCE_GROUP }}
          containerAppName: ${{ vars.AZURE_BACKEND_APP_NAME }}
          imageToDeploy: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ inputs.backend_tag }}
          containerAppEnvironment: ${{ vars.AZURE_CONTAINER_APP_ENVIRONMENT }}
          targetPort: 5000
          ingress: external
          registryUrl: ${{ env.REGISTRY }}
          registryUsername: ${{ github.actor }}
          registryPassword: ${{ secrets.GITHUB_TOKEN }}

      - name: Output Backend deployment info
        run: |
          echo "## Backend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ inputs.backend_tag }}" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend to Azure Container Apps
    runs-on: ubuntu-latest
    needs: deploy-backend
    environment: ${{ inputs.environment }}

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Frontend Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ vars.AZURE_RESOURCE_GROUP }}
          containerAppName: ${{ vars.AZURE_FRONTEND_APP_NAME }}
          imageToDeploy: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ inputs.frontend_tag }}
          containerAppEnvironment: ${{ vars.AZURE_CONTAINER_APP_ENVIRONMENT }}
          targetPort: 80
          ingress: external
          registryUrl: ${{ env.REGISTRY }}
          registryUsername: ${{ github.actor }}
          registryPassword: ${{ secrets.GITHUB_TOKEN }}

      - name: Output Frontend deployment info
        run: |
          echo "## Frontend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ inputs.frontend_tag }}" >> $GITHUB_STEP_SUMMARY

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]

    steps:
      - name: Create deployment summary
        run: |
          echo "# ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployed to Azure Container Apps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image Tag | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ inputs.backend_tag }} | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ inputs.frontend_tag }} | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
